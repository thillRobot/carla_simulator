# Information Page for custom CARLA map: Campus02

## General Information 
map name: CoE04 (College of Engineering 03)
date created: August 04, 2021

intended package: TNTech???

### Map Bounding Box Latitude and Longitude

This bounding box covers the center of TNTech campus including Derryberry Hall and the RUC. This map has terrain and a stoplight. Also, this should be a good place to test pedestrain traffic. 

max lat (N):  36.1790627
min lat (S):  36.1710401
min lat (W): -85.5108983
max lat (E): -85.494598

max lat (N):  36.1777
min lat (S):  36.1737
min lat (W): -85.5064
max lat (E): -85.5024


### Origin


??? - This will be set in RoadRunner I think 

## Collect Input Data

### OpenStreetMap Data (.osm)

JOSM version 18118 (josm-tested.jar) was used to download the OpenStreetMap data and save it as single layer .osm file.

OSM File: `maps/Campus02/Campus02.osm` 


### Elevation Data 

Digital elevation model (DEM) was downloaded from http://www.tngis.org/lidar

Campus spans DEM tiles#: 2108661NE 2108661NW 2108661SW 2108661SE

QGIS was used to combine tiles and convert elevation to meters.

DEM File: `carla_maps/large_tifs/2108661_2108669_2108653_meters.tif`

minimumHeight=  m
maximumHeight=  m


## Convert for CARLA

### Prepare OSM file with projection workaround from JHMeusener (https://github.com/JHMeusener/CarlaSimpleXODRProjectionWorkaround).

I cloned this package to `~/tools/CarlaSimpleXODRProjectionWorkaround`, and I created a virtual environment to run the workaround. I edited the paths to the input and output files before running the script `main.py`.

```
...

osmPath = '/home/$USER/carla_simulator/maps/Campus02/Campus02.osm'
...

```


```
cd ~/tool/CarlaSimpleXODRProjectionWorkaround
source waenv/bin/activate

python main.py

```
The following files were generated by the script.

- `/home/******/carla_simulator/maps/Campus02/map_modified_for_Carla.osm`
- `/home/******/carla_simulator/maps/Campus02/replace_XodrHeader_with_this.txt`

I manually copied and renamed them to:

- `/home/******/carla_simulator/maps/Campus02/Campus02_modified_for_Carla.osm`
- `/home/******/carla_simulator/maps/Campus02/Campus02_replace_XodrHeader_with_this.txt`


### Convert the prepared .osm to with .xodr with `convert_osm_xodr.py` from CARLA

I edited the paths in the script. Notice they have the strange directory backouts similar to above, but there must be a better way, this is discussed in maps.md and issues.md.
```
...

f = open("../../../maps/Campus02/Campus02_modified_for_Carla.osm", 'r')

...

f = open("../../../maps/Campus02/Campus02_CARLA.xodr", 'w')

...

```

Run the script.
```

cd ~/carla_simulator/carla/PythonAPI/carla
python3 ../util/convert_osm_xodr.py 

Warning: Discarding unknown compound 'cycleway.lane' in type 'cycleway.lane|cycleway.lane|highway.residential' (first occurence for edge '574210687').
Warning: Discarding unknown compound 'cycleway.lane' in type 'cycleway.lane|cycleway.lane|highway.residential' (first occurence for edge '574210687').
Warning: Could not write OpenDRIVE geoReference. Only unshifted Coordinate systems are supported (offset=7684531.66,-4019034.71)
```

The file `Campus02_CARLA.xodr` was generated.

### Replace header in `Campus02_CARLA.xodr` with text from `Campus02_replace_XodrHeader_with_this.txt` (following Jans instructions)

Original Header:

``` 
<header revMajor="1" revMinor="4" name="" version="1.00" date="Wed Aug  4 10:21:56 2021" north="2171.12" south="0.00" east="1774.83" west="0.00"/>
```

New Header:
```
<header revMajor="1" revMinor="4" name="" version="1" date="2019-02-18T13:36:12" north="787.8906638048566" south="1083.8986666479727" east="788.0862502383288" west="1083.825796908945">
    <geoReference><![CDATA[+proj=tmerc +lat_0=36.16321155477194 +lon_0=-85.5145521685729 +x_0=0 +y_0=0 +k_0=1.0 +ellps=GRS80 +units=m +no_defs]]></geoReference>
    </header>

```

### Import Data into Roadrunner

Open Roadrunner from Mathworks, and start a new scene called `Campus02`.

Create a new folder in the sources area called maps, then drag the folder `/maps/Campus02` into the maps folder. (That is really professional guys...)

You need the orginal `Campus01.osm` file and the modified `Campus02_CARLA.xodr` files. Also, you need the dem file `carla_maps/large_tifs/2108661_2108669_2108653_meters.tif` for the elevation projection.


First drag the `.osm` file into the map area. This will center the map around osm file which we know the bounds in lattitude and logitude.

Drag the .xodr file into the main area. Then, wave you hands in the air and watch the magic. If the map appears in the center of the screen without distortion, say THANKS JAN!

Next resize the map extend before dragging the OSM into the main area. The city layout did not show when I dragged the file `Campus02_modified_for_Carla.osm` into the area so I used the original `Campus_02.osm` and it worked as expected. Click `build roads` (check on this) to make the roads from the osm and xodr (both? check on this too!)

Next, drag the elevation map file `2108661_2108669_2108653_meters.tif` into the area, and you should see a topagraphical map appear. I have not figured out how to rotate the view to see the map in 3D. Overall the UI is terrible (sorry Mathworks, but you can do better). Change the view from `perspective` to `orthograpic` to check that the maps line up. Click `project roads` to project to roads and surfaces onto the topographical map.

You may want to check that the junctions are still intact with the . Previously used methods for converting the OSM to XODR caused the junction records to be corrupted. (see maps.md and issues.md)

Finally you are ready to export the map. Click `File >> Export >> CARLA (.fbx,.xodr,.rrdata.xml)` and select `Export to Tiles` and `Export markings as <line>`. Choose the filename `Campus02.fbx` and click `export`. All three file types listed should be created.






## QGIS
CRS: [EPSG:4326]
clipping 

road runner projection settings:

World:

XODR file:

OSM file:

XODR -> OSM offset correction. Applied in Road runner
x:
y:


files to be ingested into carla

map CoE04 is in package TNTech04
